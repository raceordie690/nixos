# Do not modify this file!  It was generated by ‘nixos-generate-config’
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, modulesPath, ... }:

{
  imports =
    [ (modulesPath + "/installer/scan/not-detected.nix")
    ];

  networking.hostName = "nixbeast";
  boot = {
    loader.efi.efiSysMountPoint = "/efi";
    initrd.availableKernelModules = [ "nvme" "xhci_pci" "amdgpu" "thunderbolt" "usbhid" "usb_storage" "sd_mod" "sdhci_pci" ];
    initrd.kernelModules = [ ];
    kernelModules = [ "kvm-amd" ];
    extraModulePackages = [  ];
    supportedFilesystems = [ "zfs" ];
    zfs.forceImportRoot = true;
    # Tell initrd how to mount the root dataset
    #loader.systemd-boot.extraInstallCommands = ''
    #  set -euxo pipefail
    #  export PATH=${pkgs.coreutils}/bin:${pkgs.util-linux}/bin:${pkgs.rsync}/bin:$PATH
#
      # Mount secondary EFI partition
#      mkdir -p /mnt/efibackup
#      mount /dev/nvme1n1p1 /mnt/efibackup
#
      # Mirror contents
#      rsync -a --delete /boot/efi /mnt/efibackup/
#
#      umount /mnt/efibackup
#    '';
  };


  fileSystems = {
    "/" =
      { device = "rpool/ROOT/nixbeast";
        fsType = "zfs";
      };

    "/efi" = 
      { device = "/dev/nvme0n1p1";
        fsType = "vfat";
        options = [ "fmask=0077" "dmask=0077" ];
      };
      
    "/efi2" = 
      { device = "/dev/nvme1n1p1";
        fsType = "vfat";
        options = [ "fmask=0077" "dmask=0077" ];
      };

    "/data" =
      { device = "rpool/data";
        fsType = "zfs";
      };

    "/home" =
      { device = "rpool/home";
        fsType = "zfs";
      };

    "/tmp" =
      { device = "rpool/tmp";
        fsType = "zfs";
      };

    "/var" =
      { device = "rpool/var";
        fsType = "zfs";
      };

    "/nix" =
      { device = "rpool/nix";
        fsType = "zfs";
      };

    "/vm" =
      { device = "rpool/vm";
        fsType = "zfs";
      };
  };

  swapDevices = [
    { device = "/dev/disk/by-uuid/ee6a7768-0532-49b9-af34-e867420b1dd1"; }
    { device = "/dev/disk/by-uuid/f327473d-d950-4db3-9bae-f2b68f3285fd"; }
    { device = "/dev/disk/by-uuid/7e1bbc7a-c35e-4439-8272-23065f677b79"; }
  ];
  networking.hostId = "8425e349";

}
